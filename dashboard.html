<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة البيانات الرئيسية لتقييم المدارس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- مكتبة ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- الهيدر -->
  <header class="bg-[#13344F] text-white shadow-md">
    <div class="container mx-auto flex items-center justify-between px-6 py-3">
      <img src="logo.png" alt="شعار سمايا" class="h-10 filter invert brightness-0">
      <h1 class="text-xl font-bold text-center flex-1">
        لوحة البيانات الرئيسية لتقييم المدارس
      </h1>
      <div class="w-10"></div>
    </div>
  </header>

  <!-- الفلاتر -->
  <section class="container mx-auto my-6 px-4">
    <div class="bg-white rounded-lg shadow p-4 flex flex-col sm:flex-row gap-6 justify-center">
      <div>
        <label for="year" class="block text-sm font-medium text-gray-700 mb-1">اختر السنة</label>
        <select id="year" class="border rounded px-3 py-2 w-40 focus:ring-2 focus:ring-blue-500">
          <option>2023</option>
          <option>2024</option>
          <option>2025</option>
        </select>
      </div>
      <div>
        <label for="month" class="block text-sm font-medium text-gray-700 mb-1">اختر الشهر</label>
        <select id="month" class="border rounded px-3 py-2 w-40 focus:ring-2 focus:ring-blue-500">
          <option>يناير</option>
          <option>فبراير</option>
          <option>مارس</option>
        </select>
      </div>
    </div>
  </section>

  <!-- المحتوى -->
  <main class="container mx-auto px-4">
    <div id="cardsContainer" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">

      <!-- كرت منطقة عسير -->
      <div class="max-w-sm mx-auto bg-white rounded-lg shadow-md p-6 text-center relative">
        <h2 class="text-lg font-bold text-gray-800 mb-4">منطقة عسير</h2>
        <div id="gauge-asir"></div>
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 text-center">
          <p id="percent-asir" class="text-4xl font-extrabold text-gray-900">0%</p>
          <p id="status-asir" class="text-2xl font-bold">جاري التحديث...</p>
        </div>
        <div class="mt-12 text-right text-base font-semibold text-gray-700 space-y-2">
          <p id="visits-asir">📊 عدد الزيارات: -</p>
          <p id="green-asir">🟢 النطاق الأخضر: -</p>
          <p id="yellow-asir">🟡 النطاق الأصفر: -</p>
          <p id="red-asir">🔴 النطاق الأحمر: -</p>
        </div>
      </div>

      <!-- كرت منطقة الباحة -->
      <div class="max-w-sm mx-auto bg-white rounded-lg shadow-md p-6 text-center relative">
        <h2 class="text-lg font-bold text-gray-800 mb-4">منطقة الباحة</h2>
        <div id="gauge-baha"></div>
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 text-center">
          <p id="percent-baha" class="text-4xl font-extrabold text-gray-900">0%</p>
          <p id="status-baha" class="text-2xl font-bold">جاري التحديث...</p>
        </div>
        <div class="mt-12 text-right text-base font-semibold text-gray-700 space-y-2">
          <p id="visits-baha">📊 عدد الزيارات: -</p>
          <p id="green-baha">🟢 النطاق الأخضر: -</p>
          <p id="yellow-baha">🟡 النطاق الأصفر: -</p>
          <p id="red-baha">🔴 النطاق الأحمر: -</p>
        </div>
      </div>

      <!-- كرت منطقة نجران -->
      <div class="max-w-sm mx-auto bg-white rounded-lg shadow-md p-6 text-center relative">
        <h2 class="text-lg font-bold text-gray-800 mb-4">منطقة نجران</h2>
        <div id="gauge-najran"></div>
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 text-center">
          <p id="percent-najran" class="text-4xl font-extrabold text-gray-900">0%</p>
          <p id="status-najran" class="text-2xl font-bold">جاري التحديث...</p>
        </div>
        <div class="mt-12 text-right text-base font-semibold text-gray-700 space-y-2">
          <p id="visits-najran">📊 عدد الزيارات: -</p>
          <p id="green-najran">🟢 النطاق الأخضر: -</p>
          <p id="yellow-najran">🟡 النطاق الأصفر: -</p>
          <p id="red-najran">🔴 النطاق الأحمر: -</p>
        </div>
      </div>

      <!-- كرت منطقة جيزان -->
      <div class="max-w-sm mx-auto bg-white rounded-lg shadow-md p-6 text-center relative">
        <h2 class="text-lg font-bold text-gray-800 mb-4">منطقة جيزان</h2>
        <div id="gauge-jazan"></div>
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 text-center">
          <p id="percent-jazan" class="text-4xl font-extrabold text-gray-900">0%</p>
          <p id="status-jazan" class="text-2xl font-bold">جاري التحديث...</p>
        </div>
        <div class="mt-12 text-right text-base font-semibold text-gray-700 space-y-2">
          <p id="visits-jazan">📊 عدد الزيارات: -</p>
          <p id="green-jazan">🟢 النطاق الأخضر: -</p>
          <p id="yellow-jazan">🟡 النطاق الأصفر: -</p>
          <p id="red-jazan">🔴 النطاق الأحمر: -</p>
        </div>
      </div>

      <!-- كرت التقييم الكلي -->
      <div class="max-w-sm mx-auto bg-white rounded-lg shadow-md p-6 text-center relative">
        <h2 class="text-lg font-bold text-gray-800 mb-4">📊 التقييم الكلي لجميع المناطق</h2>
        <div id="gauge-total"></div>
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 text-center">
          <p id="percent-total" class="text-4xl font-extrabold text-gray-900">0%</p>
          <p id="status-total" class="text-2xl font-bold">جاري التحديث...</p>
        </div>
        <div class="mt-12 text-right text-base font-semibold text-gray-700 space-y-2">
          <p id="visits-total">📊 مجموع الزيارات: -</p>
          <p id="green-total">🟢 مجموع النطاق الأخضر: -</p>
          <p id="yellow-total">🟡 مجموع النطاق الأصفر: -</p>
          <p id="red-total">🔴 مجموع النطاق الأحمر: -</p>
        </div>
      </div>

    </div>
  </main>

  <!-- سكربت المؤشرات -->
  <script>
    function getColor(value) {
      if (value >= 70) return "#16A34A";
      if (value >= 40) return "#FACC15";
      return "#DC2626";
    }

    function initGauge(id, percentId, statusId, targetValue) {
      let currentValue = 0;
      const options = {
        chart: { type: 'radialBar', height: 250 },
        series: [0],
        plotOptions: {
          radialBar: {
            startAngle: -90,
            endAngle: 90,
            hollow: { margin: 0, size: '70%' },
            track: { background: '#e0e0e0', strokeWidth: '100%' },
            dataLabels: { show: false }
          }
        },
        fill: { colors: [getColor(0)] },
      };

      const chart = new ApexCharts(document.querySelector(id), options);
      chart.render();

      const interval = setInterval(() => {
        if (currentValue < targetValue) {
          currentValue++;
          chart.updateOptions({
            series: [currentValue],
            fill: { colors: [getColor(currentValue)] }
          });
          document.querySelector(percentId).textContent = currentValue + "%";
          const statusText = document.querySelector(statusId);

          if (currentValue >= 70) {
            statusText.textContent = "ممتاز";
            statusText.className = "text-green-600 text-2xl font-bold";
          } else if (currentValue >= 40) {
            statusText.textContent = "متوسط";
            statusText.className = "text-yellow-600 text-2xl font-bold";
          } else {
            statusText.textContent = "ضعيف";
            statusText.className = "text-red-600 text-2xl font-bold";
          }
        } else {
          clearInterval(interval);
        }
      }, 20);
    }

    // ✅ جلب البيانات من Google Apps Script
    async function loadDashboard() {
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycb.../exec?action=dashboard");
        const result = await response.json();

        // تحديث الكروت حسب المناطق
        result.regions.forEach(region => {
          const key = region.region.trim(); // مثلاً: عسير، الباحة...

          if (key.includes("عسير")) {
            initGauge("#gauge-asir", "#percent-asir", "#status-asir", region.percent);
            document.getElementById("visits-asir").textContent = `📊 عدد الزيارات: ${region.visits}`;
            document.getElementById("green-asir").textContent = `🟢 النطاق الأخضر: ${region.green}`;
            document.getElementById("yellow-asir").textContent = `🟡 النطاق الأصفر: ${region.yellow}`;
            document.getElementById("red-asir").textContent = `🔴 النطاق الأحمر: ${region.red}`;
          }

          if (key.includes("الباحة")) {
            initGauge("#gauge-baha", "#percent-baha", "#status-baha", region.percent);
            document.getElementById("visits-baha").textContent = `📊 عدد الزيارات: ${region.visits}`;
            document.getElementById("green-baha").textContent = `🟢 النطاق الأخضر: ${region.green}`;
            document.getElementById("yellow-baha").textContent = `🟡 النطاق الأصفر: ${region.yellow}`;
            document.getElementById("red-baha").textContent = `🔴 النطاق الأحمر: ${region.red}`;
          }

          if (key.includes("نجران")) {
            initGauge("#gauge-najran", "#percent-najran", "#status-najran", region.percent);
            document.getElementById("visits-najran").textContent = `📊 عدد الزيارات: ${region.visits}`;
            document.getElementById("green-najran").textContent = `🟢 النطاق الأخضر: ${region.green}`;
            document.getElementById("yellow-najran").textContent = `🟡 النطاق الأصفر: ${region.yellow}`;
            document.getElementById("red-najran").textContent = `🔴 النطاق الأحمر: ${region.red}`;
          }

          if (key.includes("جيزان")) {
            initGauge("#gauge-jazan", "#percent-jazan", "#status-jazan", region.percent);
            document.getElementById("visits-jazan").textContent = `📊 عدد الزيارات: ${region.visits}`;
            document.getElementById("green-jazan").textContent = `🟢 النطاق الأخضر: ${region.green}`;
            document.getElementById("yellow-jazan").textContent = `🟡 النطاق الأصفر: ${region.yellow}`;
            document.getElementById("red-jazan").textContent = `🔴 النطاق الأحمر: ${region.red}`;
          }
        });

        // ✅ تحديث الكلي
        initGauge("#gauge-total", "#percent-total", "#status-total", result.total.percent);
        document.getElementById("visits-total").textContent = `📊 مجموع الزيارات: ${result.total.visits}`;
        document.getElementById("green-total").textContent = `🟢 مجموع النطاق الأخضر: ${result.total.green}`;
        document.getElementById("yellow-total").textContent = `🟡 مجموع النطاق الأصفر: ${result.total.yellow}`;
        document.getElementById("red-total").textContent = `🔴 مجموع النطاق الأحمر: ${result.total.red}`;

      } catch (err) {
        console.error("⚠️ خطأ في جلب بيانات الداشبورد:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", loadDashboard);
  </script>

</body>
</html>
