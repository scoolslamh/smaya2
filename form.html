<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام تقييم المباني التعليمية</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      margin: 0;
      background: #f5f7fa;
    }

    .filters {
      background: #f9fbfd;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .filters h2 {
      margin-bottom: 15px;
      color: #13344f;
      text-align: center;
    }
    .filters label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .filters select,
    .filters input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    #evaluationForm {
      display: none;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-navigation {
      text-align: center;
      margin-top: 20px;
    }
    .form-navigation button {
      margin: 5px;
      padding: 10px 25px;
      background: #13344f;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    .form-navigation button:hover {
      background: #0e2233;
    }

    header, footer {
      background: #13344f;
      color: white;
      text-align: center;
      padding: 15px 0;
    }

    header img.logo {
      height: 50px;
      display: block;
      margin: 0 auto 10px;
    }

    footer {
      font-size: 14px;
    }
  </style>
  
</head>
<body>
<!-- ✅ الهيدر للصفحات الداخلية -->
<header class="main-header">
  <!-- وسط: الشعار + العناوين -->
  <div class="header-center">
    <img src="logo.png" alt="شعار الشركة" class="logo" />
    <h1>شركــة سمايا</h1>
    <div class="subtitle">نظام تقييم المباني التعليمية</div>
  </div>
</header>

<!-- ✅ شريط الترحيب تحت الهيدر -->
<div class="welcome-bar" id="userHeader" style="display:none;">
  <span id="welcomeMsg"></span>
  <button id="logoutBtn">تسجيل الخروج</button>
</div>



  <!-- ✅ التحقق من تسجيل الدخول -->
  <script>
    if (localStorage.getItem("loggedIn") !== "true") {
      window.location.href = "index.html";
    }
  </script>

  
  <main class="container">

    <!-- قسم الفلاتر -->
    <section class="filters">
      <h2>اختيار المدرسة</h2>

      <label>المنطقة:
        <select id="regionFilter">
          <option value="">اختر المنطقة</option>
        </select>
      </label>

      <label>المدينة:
        <select id="cityFilter" disabled>
          <option value="">اختر المدينة</option>
        </select>
      </label>

      <label>المدرسة:
        <input type="text" id="schoolSearch" placeholder="🔍 ابحث عن مدرسة">
        <select id="schoolFilter" disabled>
          <option value="">اختر المدرسة</option>
        </select>
      </label>
    </section>

    <!-- شريط التقدم -->
    <div id="progress-bar">
      <div id="progress"></div>
    </div>

    <!-- ✅ معلومات آخر زيارة -->
<div id="lastVisitInfo" 
     style="display:none; text-align:center; margin:15px 0; font-weight:bold; 
            color:#13344f; background:#f0f4f8; padding:15px; border-radius:8px; font-size:16px;">
</div>

<!-- ✅ بطاقة التقييم الكلي -->
<div id="schoolEvaluation" 
     style="display:none; text-align:center; margin:15px 0; font-weight:bold; 
            color:#fff; padding:20px; border-radius:8px; font-size:18px;">
</div>
    <!-- النماذج -->
    <form id="evaluationForm" novalidate>
      <!-- القسم الأول -->
      <div class="form-step active">
        <h2>البيانات الأساسية</h2>
        <div class="form-grid">
          <label>تاريخ الزيارة:
            <input type="date" id="visit_date" name="visit_date" required>
          </label>
          <input type="hidden" id="visit_day" name="visit_day">
          <input type="hidden" id="visit_month" name="visit_month">
          <input type="hidden" id="visit_year" name="visit_year">

          <label>المشرف الزائر:
            <input type="text" name="visitor" id="visitor" readonly>
          </label>
          <label>المنطقة: <input type="text" name="region" id="region" readonly></label>
          <label>المدينة: <input type="text" name="city" id="city" readonly></label>
          <label>اسم المدرسة: <input type="text" name="school" id="school" readonly></label>

          <label>الرقم الوزاري: 
            <input type="text" name="code" id="code" required>
          </label>
          <label>اسم الحي/الشارع: 
            <input type="text" name="street" id="street">
          </label>
          <label>تصنيف المدرسة: 
  <select name="category" id="category" required>
    <option value="">اختر</option>
    <option value="صغير">صغير</option>
    <option value="وسط">وسط</option>
    <option value="كبير">كبير</option>
  </select>
</label>
          <label>المرحلة التعليمية: 
  <select name="stage" id="stage" required>
    <option value="">اختر</option>
    <option value="ابتدائي">ابتدائي</option>
    <option value="متوسط">متوسط</option>
    <option value="ثانوي">ثانوي</option>
    <option value="طفولة مبكرة">طفولة مبكرة</option>
    <option value="مجمع">مجمع</option>
  </select>
</label>
          <label>المراحل الملحقة:
             <input type="text" name="extra_stages" id="extra_stages"> 
          </label>
          
          <label>عدد الفصول: 
            <input type="number" name="classes" id="classes">
          </label>
          <label>شبكة المياه تصل للمدرسة:
            <select name="water" id="water">
              <option>نعم</option>
              <option>لا</option>
            </select>
          </label>
          <label>شبكة الصرف الصحي تصل للمدرسة:
            <select name="sewage" id="sewage">
              <option>نعم</option>
              <option>لا</option>
            </select>
          </label>
          <label>نوع الزيارة: 
  <select name="visit_type" id="visit_type" required>
    <option value="">اختر</option>
    <option value="دورية">دورية</option>
    <option value="طارئة">طارئة</option>
  </select>
</label>

          </label>
          <label>ملكية المبنى: 
            <select name="ownership" id="ownership" required>
              <option value="">اختر</option>
              <option value="حكومي">حكومي</option>
              <option value="مستأجر">مستأجر</option>
            </select>
          </label>
        </div>
        <div class="form-navigation">
          <button type="button" class="next">التالي</button>
        </div>
      </div>

      <!-- القسم الثاني -->
<div class="form-step">
  <h2>الصحة والسلامة</h2>
  <div class="form-grid">

    <!-- مخارج الطوارئ -->
    <label>مخارج الطوارئ:
      <select name="emergency_exits" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
       <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
    <label>عدد مخارج الطوارئ:
      <input type="number" name="emergency_exits_count" min="0" placeholder="0">
    </label>

    

    <!-- بكرات خرطوم الحريق -->
    <label>بكرات خرطوم الحريق:
      <select name="fire_hose_reels" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
    <label>عدد بكرات خرطوم الحريق:
      <input type="number" name="fire_hose_reels_count" min="0" placeholder="0">
    </label>

    <!-- طفايات الحريق -->
    <label>طفايات الحريق:
      <select name="fire_extinguishers" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
    <label>عدد طفايات الحريق:
      <input type="number" name="fire_extinguishers_count" min="0" placeholder="0">
    </label>

    

    <!-- كواشف إنذار الحريق -->
    <label>كواشف إنذار الحريق:
      <select name="smoke_detectors" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
    <label>عدد كواشف إنذار الحريق:
      <input type="number" name="smoke_detectors_count" min="0" placeholder="0">
    </label>

    <!-- جرس الإنذار -->
    <label>جرس إنذار:
      <select name="fire_alarm" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
    <label>عدد أجراس إنذار الحريق:
      <input type="number" name="fire_alarm_count" min="0" placeholder="0">
    </label>

<!-- نقاط التجمع -->
    <label>نقاط التجمع ولوحاتها:
      <select name="assembly_points" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>       
      </select>
    </label>
    <label>عدد نقاط التجمع ولوحاتها:
      <input type="number" name="assembly_points_count" min="0" placeholder="0">
    </label>

    <!-- حواجز السلامة -->
    <label>حواجز السلامة:
      <select name="safety_barriers" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
      </select>
    </label>

    <!-- لوحات مخارج الطوارئ -->
    <label>لوحات مخارج الطوارئ:
      <select name="exit_signs" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
<label>مسالك الهروب:
  <select name="escape_routes" id="escape_routes" required>
    <option value="">اختر</option>
    <option value="مطابق">مطابق</option>
    <option value="غير مطابق">غير مطابق</option>
  </select>
</label>
    <!-- صناديق الإسعافات الأولية -->
    <label>صناديق الإسعافات الأولية:
      <select name="first_aid" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        
      </select>
    </label>

    

    <!-- سجل المخاطر  -->
    <label>سجل المخاطر :
      <select name="edges" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
      </select>
    </label>

    <!-- وثائق السلامة -->
    <label>وثائق السلامة:
      <select name="safety_docs" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
      
      </select>
    </label>

<!-- لوحة تحكم -->
    <label>لوحة تحكم:
      <select name="control_panel" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

<!-- مضخات الحريق -->
    <label>مضخات الحريق:
      <select name="fire_pumps" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <!-- وصلة الدفاع المدني -->
    <label>وصلة الدفاع المدني:
      <select name="civil_defense" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <!-- البواب -->
    <label>البواب:
      <select name="keys" required>
        <option value="">اختر</option>
        <option value="مرضي">مرضي</option>
        <option value="غير مرضي">غير مرضي</option>
        </select>
    </label>

  </div>

  <div class="form-navigation">
    <button type="button" class="prev">السابق</button>
    <button type="button" class="next">التالي</button>
  </div>
</div>


     <!-- القسم الثالث -->
<div class="form-step">
  <h2>العناصر المدنية</h2>
  <div class="form-grid">

    <label>حالة الحوائط:
      <select name="walls_condition" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>السلالم وعناصرها:
      <select name="stairs" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>النوافذ:
      <select name="windows" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>الأبواب:
      <select name="doors" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>حالة الأرضيات:
      <select name="floors_condition" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>المناور:
      <select name="light_wells" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>عزل السطح:
      <select name="roof_insulation" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>تصريف السطح:
      <select name="roof_drainage" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>إطار السطح (السترة):
      <select name="roof_frame" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>منحدر ذوي الاحتياجات الخاصة:
      <select name="accessibility_ramp" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>الحالة العامة للمناطق الخارجية والطرق:
      <select name="external_condition" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>البوابات الرئيسية:
      <select name="main_gates" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>السور:
      <select name="fence" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>العناصر الميكانيكية:
      <select name="mechanical" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>لوحة التوزيع:
      <select name="distribution" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>نظام التأريض:
      <select name="earthing" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>أنظمة السماعات والصوت:
      <select name="sound" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>حالة الإضاءة العامة:
      <select name="lighting" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>إضاءة الطوارئ:
      <select name="emergency_lighting" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>المقابس وقنوات التمديد:
      <select name="sockets" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>مكيفات الهواء:
      <select name="ac" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>مضخات المياه:
      <select name="pumps" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>مراوح الشفط:
      <select name="fans" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>المصاعد:
      <select name="elevators" required>
        <option value="">اختر</option>
        <option value="متوفر">متوفر</option>
        <option value="غير متوفر">غير متوفر</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>سخانات المياه:
      <select name="heaters" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>خزانات المياه الأرضية:
      <select name="tank_ground" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>خزانات المياه العلوية:
      <select name="tank_top" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>الحواجز والاضافات العشوائية:
  <select name="barriers" required>
    <option value="">اختر</option>
    <option value="يوجد">يوجد</option>
    <option value="لا يوجد">لا يوجد</option>
  </select>
</label>

        <label>التوصيلات الكهربائية العشوائية:
      <select name="wiring" required>
        <option value="">اختر</option>
        <option value="يوجد">يوجد</option>
    <option value="لا يوجد">لا يوجد</option>
      </select>
    </label>

  </div>

  <div class="form-navigation">
    <button type="button" class="prev">السابق</button>
    <button type="submit">إرسال</button>
  </div>
</div>
</form>


    <!-- ✅ صندوق رسائل التنبيه -->
    <div id="formMessage" 
         style="display:none; 
                color:red; 
                font-weight:bold; 
                text-align:center; 
                margin:15px 0;">
    </div>

    <!-- أزرار إضافية -->
    <div class="form-navigation">
  <button type="button" id="newEntryBtn">🔄 إدخال جديد</button>
</div>
  </main>
 <!-- ✅ نافذة منبثقة لاستعراض الزيارات السابقة -->
<div id="visitsModal" style="display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:1000;
    justify-content:center; align-items:center;">

  <div style="background:#fff; padding:20px; border-radius:10px;
              max-width:600px; width:90%; max-height:80%; overflow:auto;">

    <h3 style="margin-top:0; color:#13344f;">📑 الزيارات السابقة</h3>
    <ul id="visitsList" style="list-style:none; padding:0;"></ul>

    <button onclick="closeVisitsModal()" 
            style="margin-top:15px; padding:8px 15px;
                   background:#13344f; color:white;
                   border:none; border-radius:5px; cursor:pointer;">
      إغلاق
    </button>
  </div>
</div>

  <!-- الفوتر -->
  <footer class="main-footer">
    <p>جميع الحقوق محفوظة لشركة سمايا © 2025</p>
  </footer>

  <script>
    let data = []; // نخزن بيانات المدارس هنا
    const API_URL = "/.netlify/functions/api";

    // استخراج اليوم/الشهر/السنة من التاريخ
    document.getElementById("visit_date").addEventListener("change", function() {
      const date = new Date(this.value);
      const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
      document.getElementById("visit_day").value = days[date.getDay()];
      document.getElementById("visit_month").value = (date.getMonth() + 1).toString().padStart(2, "0");
      document.getElementById("visit_year").value = date.getFullYear();
    });

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("visitor").value = localStorage.getItem("fullName") || "مشرف";

      // ✅ عرض رسالة الترحيب بالاسم والدور فقط عند تسجيل الدخول
      const isLoggedIn = localStorage.getItem("loggedIn") === "true";
      const role = localStorage.getItem("role") || "المشرف";
      const fullName = localStorage.getItem("fullName") || "مستخدم";
      const welcomeMsg = document.getElementById("welcomeMsg");
      const userHeader = document.getElementById("userHeader");
      const logoutBtn = document.getElementById("logoutBtn");

      if (isLoggedIn) {
        if (welcomeMsg) welcomeMsg.textContent = `👋 مرحباً، ${role}: ${fullName}`;
        if (userHeader) userHeader.style.display = "block";
      } else {
        if (userHeader) userHeader.style.display = "none";
      }

      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.clear();
          window.location.href = "index.html";
        });
      }

      document.getElementById("newEntryBtn").addEventListener("click", () => {
  // ✅ إعادة تعيين الفلاتر
  document.getElementById("regionFilter").value = "";
  document.getElementById("cityFilter").innerHTML = '<option value="">اختر المدينة</option>';
  document.getElementById("cityFilter").disabled = true;
  document.getElementById("schoolFilter").innerHTML = '<option value="">اختر المدرسة</option>';
  document.getElementById("schoolFilter").disabled = true;

  // ✅ إعادة تعيين النموذج
  const formEl = document.getElementById("evaluationForm");
  if (formEl) {
    formEl.reset();                 
    formEl.style.display = "none";  // نخفيه لحد ما يختار مدرسة من جديد
  }

  // ✅ إخفاء أي رسائل سابقة
  const messageBox = document.getElementById("formMessage");
  if (messageBox) {
    messageBox.style.display = "none";
    messageBox.textContent = "";
        }
      });

      // ✅ جلب بيانات المدارس
      try {
        const res = await fetch(API_URL);
        data = await res.json(); 

        const regionSelect = document.getElementById("regionFilter");
        const citySelect = document.getElementById("cityFilter");
        const schoolSelect = document.getElementById("schoolFilter");

        // تعبئة المناطق
        const regions = [...new Set(data.map(s => s.region))];
        regions.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          regionSelect.appendChild(opt);
        });

        // عند اختيار منطقة
        regionSelect.addEventListener("change", () => {
          const cities = [...new Set(data.filter(s => s.region === regionSelect.value).map(s => s.city))];
          citySelect.innerHTML = "<option value=''>اختر المدينة</option>";
          citySelect.disabled = false;
          cities.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            citySelect.appendChild(opt);
          });
        });

        // ✅ عند اختيار مدينة
        citySelect.addEventListener("change", () => {
          const schools = data.filter(s => s.city === citySelect.value);
          schoolSelect.innerHTML = "<option value=''>اختر المدرسة</option>";
          schoolSelect.disabled = false;
          schools.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.school;
            opt.textContent = s.school;
            schoolSelect.appendChild(opt);
          });
        });

        // ✅ البحث عن مدرسة
        document.getElementById("schoolSearch").addEventListener("input", (e) => {
          const searchTerm = e.target.value.trim().toLowerCase();
          const filteredSchools = data.filter(s => {
            const matchCity = !citySelect.value || s.city === citySelect.value;
            const matchRegion = !regionSelect.value || s.region === regionSelect.value;
            const matchName = s.school.toLowerCase().includes(searchTerm);
            return matchCity && matchRegion && matchName;
          });

          schoolSelect.innerHTML = "<option value=''>اختر المدرسة</option>";
          schoolSelect.disabled = false;
          filteredSchools.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.school;
            opt.textContent = s.school;
            schoolSelect.appendChild(opt);
          });
        });

        // ✅ عند اختيار مدرسة
        schoolSelect.addEventListener("change", () => {
          const selectedSchool = schoolSelect.value;
          const schoolInfo = data.find(s => s.school === selectedSchool);

          if (schoolInfo) {
            document.getElementById("region").value = schoolInfo.region;
            document.getElementById("city").value = schoolInfo.city;
            document.getElementById("school").value = schoolInfo.school;
            document.getElementById("code").value = schoolInfo.code;
             // 🟢   السطر التالي لفحص البيانات
    console.log("schoolInfo:", schoolInfo);
           // ✅ إظهار آخر زيارة وعدد الزيارات
const infoBox = document.getElementById("lastVisitInfo");
let formattedDate = "لا يوجد";
if (schoolInfo.last_visit) {
  const visitDate = new Date(schoolInfo.last_visit);
  formattedDate = visitDate.toLocaleDateString("ar-EG", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

// ✅ إضافة النص + زر الاستعراض
infoBox.innerHTML = `
  🗓️ آخر زيارة: <b>${formattedDate}</b> |
  🔢 عدد الزيارات: <b>${schoolInfo.visits || 0}</b>
  <br>
  <button id="viewVisitsBtn"
          style="margin-top:10px; padding:8px 15px;
                 background:#007BFF; color:white;
                 border:none; border-radius:5px; cursor:pointer;">
    استعراض الزيارات السابقة
  </button>
`;
infoBox.style.display = "block";

// ✅ جلب التقييم الكلي من آخر زيارة
(async () => {
  if (schoolInfo.last_visit && schoolInfo.visits > 0) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "getVisitReport",
          school: schoolInfo.school,
          visit: schoolInfo.visits  // 👈 رقم آخر زيارة
        })
      });

      const result = await res.json();
      if (result.success && result.data) {
        const totalSum = Number(result.data.total_sum) || 0;
        const totalPercent = Number(result.data.total_percent) || 0;
        renderSchoolEvaluation(totalSum, totalPercent);
      } else {
        console.warn("⚠️ لم يتم العثور على بيانات التقييم الكلي من التقارير.");
      }
    } catch (err) {
      console.error("❌ خطأ في جلب التقييم الكلي:", err);
    }
  }
})();


    // ✅ ربط حدث الضغط على الزر
const viewBtn = document.getElementById("viewVisitsBtn");
if (viewBtn) {
  viewBtn.addEventListener("click", async () => {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "getVisits",
          school: schoolInfo.school
        })
      });

      if (!res.ok) throw new Error("فشل في جلب البيانات");

      const result = await res.json();
      if (result.success && result.visits.length > 0) {
        // ✅ إنشاء نافذة منبثقة
        let modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0,0,0,0.5)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "9999";

        // ✅ صندوق القائمة
        let box = document.createElement("div");
        box.style.background = "white";
        box.style.padding = "20px";
        box.style.borderRadius = "10px";
        box.style.width = "400px";
        box.style.maxHeight = "70%";
        box.style.overflowY = "auto";
        box.innerHTML = `<h3>📑 زيارات ${schoolInfo.school}</h3><ul id="visitsList"></ul>
                         <button id="closeModal" 
                           style="margin-top:15px;padding:8px 15px;background:#dc3545;color:white;
                           border:none;border-radius:5px;cursor:pointer;">إغلاق</button>`;

        modal.appendChild(box);
        document.body.appendChild(modal);

        // ✅ تعبئة القائمة
const list = box.querySelector("#visitsList");
result.visits.forEach(v => {
  // تنسيق التاريخ إلى dd-mm-yyyy
  let formattedDate = "-";
  if (v.visit_date) {
    const dateObj = new Date(v.visit_date);
    const day = ("0" + dateObj.getDate()).slice(-2);
    const month = ("0" + (dateObj.getMonth() + 1)).slice(-2);
    const year = dateObj.getFullYear();
    formattedDate = `${day}-${month}-${year}`;
  }

  const li = document.createElement("li");
  li.style.marginBottom = "8px";
  li.innerHTML = `<a href="report.html?school=${encodeURIComponent(v.school)}&visit=${v.visit_number}" target="_blank">
          🗓️ ${formattedDate} - زيارة رقم ${v.visit_number}
        </a>`;
  list.appendChild(li);
});

        // ✅ زر إغلاق
        box.querySelector("#closeModal").addEventListener("click", () => {
          document.body.removeChild(modal);
        });

      } else {
        alert("⚠️ لا توجد زيارات سابقة لهذه المدرسة");
      }
    } catch (err) {
      console.error("خطأ في جلب الزيارات:", err);
      alert("❌ حدث خطأ أثناء جلب الزيارات");
    }
  });
}


    // ✅ إظهار النموذج
    document.getElementById("evaluationForm").style.display = "block";
  }
});

      } catch (err) {
        console.error("خطأ في تحميل المدارس:", err);
        alert("⚠️ لم يتم تحميل بيانات المدارس من الشيت");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const steps = document.querySelectorAll(".form-step");
      const nextBtns = document.querySelectorAll(".next");
      const prevBtns = document.querySelectorAll(".prev");
      let currentStep = 0;

      function showStep(index) {
        steps.forEach((step, i) => {
          step.style.display = i === index ? "block" : "none";
        });
      }

      nextBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          if (currentStep < steps.length - 1) {
            currentStep++;
            showStep(currentStep);
          }
        });
      });

      prevBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          if (currentStep > 0) {
            currentStep--;
            showStep(currentStep);
          }
        });
      });

      showStep(currentStep);
    });

   // ✅ إرسال النموذج إلى Google Sheet
document.getElementById("evaluationForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  const messageBox = document.getElementById("formMessage");

  const requiredFields = form.querySelectorAll("[required]");
  let missing = [];
  requiredFields.forEach(field => {
    if (!field.value || field.value.trim() === "") {
      missing.push(field);
      field.style.border = "2px solid red";
    } else {
      field.style.border = "";
    }
  });

  if (missing.length > 0) {
    messageBox.textContent = "⚠️ عليك إكمال باقي الحقول المطلوبة";
    messageBox.style.display = "block";
    return;
  } else {
    messageBox.style.display = "none";
  }

  const formData = new FormData(form);
  const data = {};
  formData.forEach((value, key) => {
    data[key] = value;
  });

  // ✅ فحص قيمة مسالك الهروب
  console.log("🚀 escape_routes:", data.escape_routes);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "saveEvaluation",
        ...data
      })
    });

    if (!res.ok) throw new Error("فشل الاتصال بالخادم");

    const result = await res.json();
    if (result.success) {
  alert("✅ شكراً، تم إرسال التقرير بنجاح!");
  // إعادة تحميل الصفحة بعد ثانيتين
  setTimeout(() => {
    window.location.reload();
  }, 2000);
} else {
  alert("⚠️ لم يتم الإرسال: " + (result.message || "خطأ غير معروف"));
}
} catch (err) {
  console.error("خطأ:", err);
  alert("❌ فشل الاتصال بالخادم");
}
});
// ✅ دالة عرض التقييم الكلي
  function renderSchoolEvaluation(totalSum, totalPercent) {
    const box = document.getElementById("schoolEvaluation");

    let grade = "ضعيف";
    let bgColor = "#f44336"; // 🔴 أحمر

    if (totalPercent >= 90) {
      grade = "ممتاز"; bgColor = "#2e7d32";
    } else if (totalPercent >= 80) {
      grade = "جيد جدًا"; bgColor = "#388e3c";
    } else if (totalPercent >= 70) {
      grade = "جيد"; bgColor = "#fbc02d";
    }

    box.style.cssText = `
      background: ${bgColor};
      color: #fff;
      font-weight: bold;
      padding: 15px;
      margin-top: 15px;
      border-radius: 10px;
      text-align: center;
      font-size: 16px;
    `;

    // ✅ المحتوى في صف واحد
box.innerHTML = `
  <div style="display:flex; justify-content:space-around; align-items:center; gap:15px; flex-wrap:wrap;">
    <span>📊 <b>التقييم الكلي</b></span>
    <span>🔢 المجموع: ${totalSum}</span>
    <span>📈 النسبة: ${totalPercent.toFixed(1)}%</span>
    <span>🏆 التقدير: ${grade}</span>
  </div>
`;
  }
</script>
</body>
</html>

