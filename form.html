<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام تقييم المباني المدرسية</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      margin: 0;
      background: #f5f7fa;
    }

    .filters {
      background: #f9fbfd;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .filters h2 {
      margin-bottom: 15px;
      color: #13344f;
      text-align: center;
    }
    .filters label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .filters select,
    .filters input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    #evaluationForm {
      display: none;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-navigation {
      text-align: center;
      margin-top: 20px;
    }
    .form-navigation button {
      margin: 5px;
      padding: 10px 25px;
      background: #13344f;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    .form-navigation button:hover {
      background: #0e2233;
    }

    header, footer {
      background: #13344f;
      color: white;
      text-align: center;
      padding: 15px 0;
    }

    header img.logo {
      height: 50px;
      display: block;
      margin: 0 auto 10px;
    }

    footer {
      font-size: 14px;
    }
  </style>
  
</head>
<body>

  <!-- ✅ التحقق من تسجيل الدخول -->
  <script>
    let data = []; // نخزن فيه بيانات المدارس
    if (localStorage.getItem("loggedIn") !== "true") {
      window.location.href = "index.html";
    }
  </script>

  <!-- الهيدر -->
  <header class="main-header">
    <img src="logo.png" alt="شعار شركة سمايا" class="logo">
    <h1>شركـــة سمايا</h1>
    <h2 class="subtitle">نظام تقييم المباني المدرسية</h2>
  </header>

  <main class="container">

    <!-- قسم الفلاتر -->
    <section class="filters">
      <h2>اختيار المدرسة</h2>

      <label>المنطقة:
        <select id="regionFilter">
          <option value="">اختر المنطقة</option>
        </select>
      </label>

      <label>المدينة:
        <select id="cityFilter" disabled>
          <option value="">اختر المدينة</option>
        </select>
      </label>

      <label>المدرسة:
        <input type="text" id="schoolSearch" placeholder="🔍 ابحث عن مدرسة">
        <select id="schoolFilter" disabled>
          <option value="">اختر المدرسة</option>
        </select>
      </label>
    </section>

    <!-- شريط التقدم -->
    <div id="progress-bar">
      <div id="progress"></div>
    </div>
    <!-- ✅ معلومات آخر زيارة -->
<div id="lastVisitInfo" 
     style="display:none; text-align:center; margin:15px 0; font-weight:bold; color:#13344f; background:#f0f4f8; padding:10px; border-radius:6px;">
</div>
    <!-- النماذج -->
    <form id="evaluationForm" novalidate>

      <!-- القسم الأول -->
<div class="form-step active">
  <h2>البيانات الأساسية</h2>
  <div class="form-grid">
    <label>تاريخ الزيارة:
      <input type="date" id="visit_date" name="visit_date" required>
    </label>
    <input type="hidden" id="visit_day" name="visit_day">
    <input type="hidden" id="visit_month" name="visit_month">
    <input type="hidden" id="visit_year" name="visit_year">

    <label>المشرف الزائر:
      <input type="text" name="visitor" id="visitor" readonly>
    </label>
    <label>المنطقة: <input type="text" name="region" id="region" readonly></label>
    <label>المدينة: <input type="text" name="city" id="city" readonly></label>
    <label>اسم المدرسة: <input type="text" name="school" id="school" readonly></label>

    <label>الرقم الوزاري: 
      <input type="text" name="code" id="code" required>
    </label>
    <label>اسم الحي/الشارع: 
      <input type="text" name="street" id="street">
    </label>
    <label>تصنيف المدرسة: 
      <input type="text" name="category" id="category">
    </label>
    <label>المرحلة التعليمية: 
      <input type="text" name="stage" id="stage">
    </label>
    <label>المراحل الملحقة: 
      <input type="text" name="extra_stages" id="extra_stages">
    </label>
    <label>تاريخ الفحص: 
      <input type="date" name="inspection_date" id="inspection_date">
    </label>
    <label>عدد الفصول: 
      <input type="number" name="classes" id="classes">
    </label>
    <label>شبكة المياه تصل للمدرسة:
      <select name="water" id="water">
        <option>نعم</option>
        <option>لا</option>
      </select>
    </label>
    <label>شبكة الصرف الصحي تصل للمدرسة:
      <select name="sewage" id="sewage">
        <option>نعم</option>
        <option>لا</option>
      </select>
    </label>
    <label>طرق الوصول للمدرسة: 
      <input type="text" name="access" id="access">
    </label>
    <label>ملكية المبنى: 
      <input type="text" name="ownership" id="ownership">
    </label>
  </div>
  <div class="form-navigation">
    <button type="button" class="next">التالي</button>
  </div>
</div>

<!-- ✅ صندوق الرسالة (أضفه هنا قبل القسم الثاني أو بعده) -->
  <div id="formMessage" 
       style="display:none; color:red; font-weight:bold; text-align:center; margin:15px 0;">
  </div>

      <!-- القسم الثاني -->
<div class="form-step">
  <h2>الصحة والسلامة</h2>
  <div class="form-grid">
    <label>مخارج الطوارئ:
      <select name="emergency_exits" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>مضخات الحريق:
      <select name="fire_pumps" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>بكرات خرطوم الحريق:
      <select name="fire_hose_reels" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>طفايات الحريق:
      <select name="fire_extinguishers" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>لوحة تحكم:
      <select name="control_panel" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>كواشف إنذار الحريق:
      <select name="smoke_detectors" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>جرس انذار:
      <select name="fire_alarm" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>حواجز السلامة:
      <select name="safety_barriers" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>لوحات مخارج الطوارئ:
      <select name="exit_signs" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>صناديق الإسعافات الأولية:
      <select name="first_aid" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>نقاط التجمع ولوحاتها:
      <select name="assembly_points" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>الحواف المكشوفة:
      <select name="edges" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>وثائق السلامة:
      <select name="safety_docs" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>وصلة الدفاع المدني:
      <select name="civil_defense" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>

    <label>الأبواب والمفاتيح:
      <select name="keys" required>
        <option value="">اختر</option>
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
        <option value="يحتاج صيانة">يحتاج صيانة</option>
      </select>
    </label>
  </div>

  <div class="form-navigation">
    <button type="button" class="prev">السابق</button>
    <button type="button" class="next">التالي</button>
  </div>
</div>


      <!-- القسم الثالث -->
      <div class="form-step">
        <h2>العناصر المدنية</h2>
        <div class="form-grid">
          <label>حالة الحوائط: <input type="text" name="walls_condition"></label>
          <label>السلالم وعناصرها: <input type="text" name="stairs"></label>
          <label>النوافذ: <input type="text" name="windows"></label>
          <label>الأبواب: <input type="text" name="doors"></label>
          <label>حالة الأرضيات: <input type="text" name="floors_condition"></label>
          <label>المناور: <input type="text" name="light_wells"></label>
          <label>عزل السطح: <input type="text" name="roof_insulation"></label>
          <label>تصريف السطح: <input type="text" name="roof_drainage"></label>
          <label>إطار السطح / الحواجز: <input type="text" name="roof_frame"></label>
          <label>منحدر ذوي الاحتياجات الخاصة: <input type="text" name="accessibility_ramp"></label>
          <label>الحالة العامة للمناطق الخارجية والطرق: <input type="text" name="external_condition"></label>
          <label>البوابات الرئيسية: <input type="text" name="main_gates"></label>
          <label>السور: <input type="text" name="fence"></label>
          <label>العناصر الميكانيكية: <input type="text" name="mechanical"></label>
          <label>لوحة التوزيع: <input type="text" name="distribution"></label>
          <label>نظام التأريض: <input type="text" name="earthing"></label>
          <label>أنظمة السماعات والصوت: <input type="text" name="sound"></label>
          <label>حالة الإضاءة العامة: <input type="text" name="lighting"></label>
          <label>إضاءة الطوارئ: <input type="text" name="emergency_lighting"></label>
          <label>المقابس وقنوات التمديد: <input type="text" name="sockets"></label>
          <label>مكيفات الهواء: <input type="text" name="ac"></label>
          <label>المضخات: <input type="text" name="pumps"></label>
          <label>مراوح الشفط: <input type="text" name="fans"></label>
          <label>المصاعد: <input type="text" name="elevators"></label>
          <label>سخانات المياه: <input type="text" name="heaters"></label>
          <label>خزانات المياه الأرضية: <input type="text" name="tank_ground"></label>
          <label>خزانات المياه العلوية: <input type="text" name="tank_top"></label>
          <label>الحواجز والاضافات العشوائية: <input type="text" name="barriers"></label>
          <label>التوصيلات الكهربائية العشوائية: <input type="text" name="wiring"></label>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev">السابق</button>
          <button type="submit">إرسال</button>
        </div>
      </div>
    </form>

    <!-- أزرار إضافية -->
    <div class="form-navigation">
      <button type="button" id="newEntryBtn">🔄 إدخال جديد</button>
      <button type="button" id="logoutBtn">🚪 خروج</button>
    </div>
  </main>

  <!-- الفوتر -->
  <footer class="main-footer">
    <p>جميع الحقوق محفوظة لشركة سمايا © 2025</p>
  </footer>

  <script>
     let data = []; // ✅ تعريف المتغير في البداية
     async function loadSchools() {
  try {
    const res = await fetch(API_URL);
    data = await res.json(); 
    console.log("📦 تم جلب المدارس:", data);

    // 🟢 ملء الفلاتر (المنطقة)
    const regionSelect = document.getElementById("regionFilter");
    const citySelect = document.getElementById("cityFilter");
    const schoolSelect = document.getElementById("schoolSelect");

    // تفريغ القديم
    regionSelect.innerHTML = "<option disabled selected>اختر المنطقة</option>";
    citySelect.innerHTML = "<option disabled selected>اختر المدينة</option>";
    schoolSelect.innerHTML = "<option disabled selected>اختر المدرسة</option>";

    // ملء المناطق بدون تكرار
    const regions = [...new Set(data.map(s => s.region))];
    regions.forEach(r => {
      let opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      regionSelect.appendChild(opt);
    });

    // 🟢 عند اختيار منطقة → نملأ المدن
    regionSelect.addEventListener("change", () => {
      const selectedRegion = regionSelect.value;
      const cities = [...new Set(data.filter(s => s.region === selectedRegion).map(s => s.city))];

      citySelect.innerHTML = "<option disabled selected>اختر المدينة</option>";
      schoolSelect.innerHTML = "<option disabled selected>اختر المدرسة</option>";

      cities.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        citySelect.appendChild(opt);
      });
    });

    // 🟢 عند اختيار مدينة → نملأ المدارس
    citySelect.addEventListener("change", () => {
      const selectedRegion = regionSelect.value;
      const selectedCity = citySelect.value;
      const schools = data.filter(s => s.region === selectedRegion && s.city === selectedCity);

      schoolSelect.innerHTML = "<option disabled selected>اختر المدرسة</option>";
      schools.forEach(sc => {
        let opt = document.createElement("option");
        opt.value = sc.school;
        opt.textContent = sc.school;
        schoolSelect.appendChild(opt);
      });
    });

  } catch (err) {
    console.error("❌ خطأ في تحميل المدارس:", err);
  }
}


// استدعاء الدالة عند تحميل الصفحة
loadSchools();

    const API_URL = "/api";

    // استخراج اليوم/الشهر/السنة من التاريخ
    document.getElementById("visit_date").addEventListener("change", function() {
      const date = new Date(this.value);
      const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
      document.getElementById("visit_day").value = days[date.getDay()];
      document.getElementById("visit_month").value = (date.getMonth() + 1).toString().padStart(2, "0");
      document.getElementById("visit_year").value = date.getFullYear();
    });

    document.addEventListener("DOMContentLoaded", async () => {
      // تحميل اسم المشرف
      document.getElementById("visitor").value = localStorage.getItem("fullName") || "مشرف";

      // زر الخروج
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "index.html";
      });

      // زر إدخال جديد
      document.getElementById("newEntryBtn").addEventListener("click", () => {
        document.getElementById("evaluationForm").reset();
        document.getElementById("evaluationForm").style.display = "none";
      });

      // ✅ جلب بيانات المدارس
      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        const regionSelect = document.getElementById("regionFilter");
        const citySelect = document.getElementById("cityFilter");
        const schoolSelect = document.getElementById("schoolFilter");

        // تعبئة المناطق
        const regions = [...new Set(data.map(s => s.region))];
        regions.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          regionSelect.appendChild(opt);
        });

        // عند اختيار منطقة
        regionSelect.addEventListener("change", () => {
          const cities = [...new Set(data.filter(s => s.region === regionSelect.value).map(s => s.city))];
          citySelect.innerHTML = "<option value=''>اختر المدينة</option>";
          citySelect.disabled = false;
          cities.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            citySelect.appendChild(opt);
          });
        });

        // عند اختيار مدينة
        citySelect.addEventListener("change", () => {
          const schools = data.filter(s => s.city === citySelect.value);
          schoolSelect.innerHTML = "<option value=''>اختر المدرسة</option>";
          schoolSelect.disabled = false;
          schools.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.school;
            opt.textContent = s.school;
            schoolSelect.appendChild(opt);
          });
        });

        // 🟢 عند اختيار مدرسة
schoolSelect.addEventListener("change", () => {
  const selectedSchool = schoolSelect.value;
  const schoolData = data.find(s => s.school === selectedSchool);

  if (schoolData) {
    document.getElementById("region").value = schoolData.region;
    document.getElementById("city").value = schoolData.city;
    document.getElementById("school").value = schoolData.school;
    document.getElementById("code").value = schoolData.code;

    // ✅ عرض آخر زيارة وعدد الزيارات
    const infoBox = document.getElementById("lastVisitInfo");
    infoBox.innerHTML = `
      📅 آخر زيارة: <b>${schoolData.last_visit || "لا يوجد"}</b> |
      🔢 عدد الزيارات: <b>${schoolData.visits || 0}</b>
    `;
    infoBox.style.display = "block";
  } else {
    document.getElementById("lastVisitInfo").innerHTML =
      "⚠️ لم يتم العثور على بيانات لهذه المدرسة";
  }

  document.getElementById("evaluationForm").style.display = "block";
});

  // ✅ جلب آخر زيارة من السكربت
  try {
    console.log("🚀 بدء طلب آخر زيارة للمدرسة:", schoolData.school);
    const res = await fetch(API_URL + "?school=" + encodeURIComponent(schoolData.school));
    console.log("🔗 الرابط المستخدم:", API_URL + "?school=" + encodeURIComponent(schoolData.school));

    const result = await res.json();
    console.log("📦 الرد القادم من السكربت:", result);

    const infoBox = document.getElementById("lastVisitInfo");

    if (result && result.success) {
      console.log("✅ تم العثور على زيارة سابقة");

      const visitId = result.visit_id;       // رقم الزيارة
      const visitDate = new Date(result.visit_date); // تحويل النص إلى تاريخ
      const formattedDate = visitDate.toLocaleDateString("ar-EG", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });

      infoBox.innerHTML = `📅 تاريخ آخر زيارة: <b>${formattedDate}</b> | 🔢 رقم الزيارة: <b>${visitId}</b>`;
      infoBox.style.display = "block";
    } else {
      console.warn("⚠️ لم يتم العثور على زيارة سابقة");
      infoBox.innerHTML = "⚠️ لا يوجد زيارة سابقة لهذه المدرسة";
      infoBox.style.display = "block";
    }
  } catch (err) {
    console.error("❌ خطأ في جلب آخر زيارة:", err);
  }
});



      } catch (err) {
        console.error("خطأ في تحميل المدارس:", err);
        alert("⚠️ لم يتم تحميل بيانات المدارس من الشيت");
      }
    });
    // ✅ التحكم في الخطوات (التالي/السابق)
document.addEventListener("DOMContentLoaded", () => {
  const steps = document.querySelectorAll(".form-step");
  const nextBtns = document.querySelectorAll(".next");
  const prevBtns = document.querySelectorAll(".prev");
  let currentStep = 0;

  function showStep(index) {
    steps.forEach((step, i) => {
      step.style.display = i === index ? "block" : "none";
    });
  }

  showStep(currentStep);

  nextBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    });
  });

  prevBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    });
  });
});
// ✅ إرسال النموذج إلى Google Sheet
document.getElementById("evaluationForm").addEventListener("submit", async (e) => {
  e.preventDefault(); // منع إعادة تحميل الصفحة

  const form = e.target;
  const messageBox = document.getElementById("formMessage");

  // ✅ التحقق من الحقول المطلوبة
  const requiredFields = form.querySelectorAll("[required]");
  let missing = [];

  requiredFields.forEach(field => {
    if (!field.value || field.value.trim() === "") {
      missing.push(field);
      field.style.border = "2px solid red"; // تمييز الحقول الناقصة
    } else {
      field.style.border = ""; // إزالة التمييز إذا امتلأ
    }
  });

  if (missing.length > 0) {
    messageBox.textContent = "⚠️ عليك إكمال باقي الحقول المطلوبة";
    messageBox.style.display = "block";
    return; // إيقاف الإرسال
  } else {
    messageBox.style.display = "none"; // إخفاء الرسالة إذا كل شيء تمام
  }

  // ✅ إذا جميع الحقول ممتلئة → تجهيز البيانات
  const formData = new FormData(form);
  const data = {};
  formData.forEach((value, key) => {
    data[key] = value;
  });

  try {
    const res = await fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    action: "saveEvaluation",   // ✅ يتوافق مع السكربت
    ...data                     // ✅ إرسال القيم مباشرة بدون payload
  })
});



    if (!res.ok) throw new Error("فشل الاتصال بالخادم");

    const result = await res.json();

    if (result.success) {
      alert("✅ تم إرسال التقييم بنجاح!");
      form.reset();
      document.getElementById("evaluationForm").style.display = "none";
    } else {
      alert("⚠️ لم يتم الإرسال: " + (result.message || "خطأ غير معروف"));
    }
  } catch (err) {
    console.error("خطأ:", err);
    alert("❌ فشل الاتصال بالخادم");
  }
});
// ✅ تعريف عناصر HTML
const schoolSelect = document.getElementById("schoolFilter");
const infoBox = document.getElementById("lastVisitInfo");

// ✅ عند اختيار مدرسة من القائمة
schoolSelect.addEventListener("change", () => {
  const selectedSchool = schoolSelect.value;
  const schoolInfo = data.find(s => s.school === selectedSchool);

  if (schoolInfo) {
    infoBox.innerHTML = `
      🗓️ آخر زيارة: <b>${schoolInfo.last_visit || "لا يوجد"}</b> |
      🔢 عدد الزيارات: <b>${schoolInfo.visits || 0}</b>
    `;
    infoBox.style.display = "block";
  } else {
    infoBox.innerHTML = "⚠️ لم يتم العثور على بيانات لهذه المدرسة";
    infoBox.style.display = "block";
  }
});
  </script>
  
</body>
</html>
