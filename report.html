<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุชูุฑูุฑ ุฒูุงุฑุฉ ูุจูู ูุฏุฑุณู</title>
  <!-- ุฑุจุท ููู CSS -->
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    /* โ ุงูููุฏุฑ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #13344f;
      color: white;
      padding: 8px 20px;
    }
    .header .title h1 {
      margin: 0;
      font-size: 18px;
    }
    .header .title p {
      margin: 0;
      font-size: 14px;
      color: #ddd;
    }
    .header .logo {
      height: 40px;
    }

    /* โ ุงูุชูุฑูุฑ */
    .report-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 1200px;
      display: none; /* ูุฎููู ุญุชู ูุชู ุชุญููู ุงูุจูุงูุงุช */
    }
    .report-container h2 {
      text-align: center;
      color: #13344f;
      margin-bottom: 10px;
    }
    .section-title {
      margin: 25px 0 10px;
      padding: 10px;
      background: #13344f;
      color: #fff;
      border-radius: 6px;
      font-size: 16px;
    }

    /* โ ุชูุณููุงุช ุงูุฌุฏูู */
    .report-table {
      width: 100%;
      border-collapse: collapse; /* ุฏูุฌ ุงูุญุฏูุฏ */
      border: 2px solid #13344f; /* ุฅุทุงุฑ ุฎุงุฑุฌู */
    }
    .report-table th, 
    .report-table td {
      border: 1px solid #999;  /* ุญุฏูุฏ ุฃูุถุญ */
      padding: 8px;
      text-align: center;      /* โ ุชูุณูุท ุฃููู */
      vertical-align: middle;  /* โ ุชูุณูุท ุนููุฏู */
      font-size: 14px;
    }
    .report-table th {
      background: #f0f4f8;
      color: #13344f;
      font-weight: bold;
      width: 15%;
    }
    .report-table td {
      width: 18%;
      font-weight: bold;   /* โ ุงูููู ุจุฎุท ุจููุฏ */
      color: #000;
      font-size: 15px;
    }

    /* โ ุฒุฑ ุงูุทุจุงุนุฉ */
    .print-btn {
      display: block;
      margin: 25px auto 0;
      padding: 10px 20px;
      background: #13344f;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .print-btn:hover {
      background: #0e2233;
    }

    /* โ ุดุงุดุฉ ุงูุชุญููู */
    .loader {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #13344f;
      font-size: 18px;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #13344f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- โ ุงูููุฏุฑ -->
  <div class="header">
    <div class="title">
      <h1>ุดุฑูุฉ ุณูุงูุง</h1>
      <p>ุชูุฑูุฑ ุฒูุงุฑุฉ ูุจูู ูุฏุฑุณู</p>
    </div>
    <img src="logo.png" alt="ุดุนุงุฑ ุณูุงูุง" class="logo">
  </div>

  <!-- โ ุดุงุดุฉ ุงูุชุญููู -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div>ุฌุงุฑู ุชุญููู ุงูุชูุฑูุฑ...</div>
  </div>

  <!-- โ ูุญุชูู ุงูุชูุฑูุฑ -->
  <div class="report-container" id="reportContainer">
    <h2>๐ ุชูุฑูุฑ ุฒูุงุฑุฉ ุงููุฏุฑุณุฉ</h2>

    <!-- โ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ -->
<div class="section-title">๐ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</div>
<table class="report-table">
  <tr>
    <th>๐ ุงูุชุงุฑูุฎ</th><td id="visit_date"></td>
    <th>๐ ุงูููู</th><td id="visit_day"></td>
    <th>๐ค ุงููุดุฑู ุงูุฒุงุฆุฑ</th><td id="visitor"></td>
  </tr>
  <tr>
    <th>๐ซ ุงููุฏุฑุณุฉ</th><td id="school"></td>
    <th>๐ข ุงูููุทูุฉ</th><td id="region"></td>
    <th>๐๏ธ ุงููุฏููุฉ</th><td id="city"></td>
  </tr>
  <tr>
    <th>๐ ุงูุฑูู ุงููุฒุงุฑู</th><td id="code"></td>
    <th>๐ ุงูุญู / ุงูุดุงุฑุน</th><td id="street"></td>
    <th>๐ ุชุตููู ุงููุฏุฑุณุฉ</th><td id="category"></td>
  </tr>
  <tr>
    <th>๐ท๏ธ ุงููุฑุญูุฉ ุงูุชุนููููุฉ</th><td id="stage"></td>
    <th>โ ูุฑุงุญู ููุญูุฉ</th><td id="extra_stages"></td>
    <th>๐ซ ุนุฏุฏ ุงููุตูู</th><td id="classes"></td>
  </tr>
  <tr>
    <th>๐ง ุดุจูุฉ ุงูููุงู</th><td id="water"></td>
    <th>๐ฐ ุดุจูุฉ ุงูุตุฑู ุงูุตุญู</th><td id="sewage"></td>
    <th>๐ ููุน ุงูุฒูุงุฑุฉ</th><td id="access"></td>
  </tr>
  <tr>
    <th>๐ ููููุฉ ุงููุจูู</th><td id="ownership"></td>
    <td colspan="4"></td>
  </tr>
</table>

    <!-- โ ุงูุตุญุฉ ูุงูุณูุงูุฉ -->
    <div class="section-title">๐จ ุงูุตุญุฉ ูุงูุณูุงูุฉ</div>
    <table class="report-table">
      <tr>
        <th>๐ช ูุฎุงุฑุฌ ุงูุทูุงุฑุฆ</th><td id="emergency_exits"></td>
        <th>๐ข ุนุฏุฏ ูุฎุงุฑุฌ ุงูุทูุงุฑุฆ</th><td id="emergency_exits_count"></td>
        <th>๐งฏ ุทูุงูุงุช ุงูุญุฑูู</th><td id="fire_extinguishers"></td>
      </tr>
      <tr>
        <th>๐ข ุนุฏุฏ ุงูุทูุงูุงุช</th><td id="fire_extinguishers_count"></td>
        <th>๐งต ุจูุฑุงุช ุฎุฑุทูู ุงูุญุฑูู</th><td id="fire_hose_reels"></td>
        <th>๐ข ุนุฏุฏ ุงูุจูุฑุงุช</th><td id="fire_hose_reels_count"></td>
      </tr>
      <tr>
        <th>๐ข ุฌุฑุณ ุงูุฅูุฐุงุฑ</th><td id="fire_alarm"></td>
        <th>๐ข ุนุฏุฏ ุฃุฌุฑุงุณ ุงูุฅูุฐุงุฑ</th><td id="fire_alarm_count"></td>
        <th>๐จ ููุงุดู ุงูุฏุฎุงู</th><td id="smoke_detectors"></td>
      </tr>
      <tr>
        <th>๐ข ุนุฏุฏ ุงูููุงุดู</th><td id="smoke_detectors_count"></td>
        <th>๐ง ุญูุงุฌุฒ ุงูุณูุงูุฉ</th><td id="safety_barriers"></td>
        <th>๐ช ููุญุงุช ุงููุฎุงุฑุฌ</th><td id="exit_signs"></td>
      </tr>
      <tr>
        <th>โ๏ธ ุฅุณุนุงูุงุช ุฃูููุฉ</th><td id="first_aid"></td>
        <th>๐ ููุงุท ุงูุชุฌูุน</th><td id="assembly_points"></td>
        <th>๐ข ุนุฏุฏ ููุงุท ุงูุชุฌูุน</th><td id="assembly_points_count"></td>
      </tr>
      <tr>
        <th>๐ ูุซุงุฆู ุงูุณูุงูุฉ</th><td id="safety_docs"></td>
        <th>๐ก ูุตูุฉ ุงูุฏูุงุน ุงููุฏูู</th><td id="civil_defense"></td>
        <th>๐ฎโโ๏ธ ุงูุจููุงุจ</th><td id="keys"></td>
      </tr>
      <tr>
        <th>โก ููุญุฉ ุงูุชุญูู</th><td id="control_panel"></td>
        <th>๐ ุณุฌู ุงููุฎุงุทุฑ</th><td id="edges"></td>
        <th>๐ง ูุถุฎุงุช ุงูุญุฑูู</th><td id="fire_pumps"></td>
      </tr>
      <tr>
  <th>๐ช ูุณุงูู ุงููุฑูุจ</th><td id="escape_routes"></td>
</tr>
    </table>
     <!-- โ ุตูุฏูู ููุฎุต ุงูุตุญุฉ ูุงูุณูุงูุฉ -->
<div class="summary-box">
  <div><strong>๐ ูุฌููุน ุงูุตุญุฉ ูุงูุณูุงูุฉ:</strong> <span id="health_sum">-</span></div>
  <div><strong>ุงููุณุจุฉ:</strong> <span id="health_percent" class="percent-box">-</span></div>
</div>
    <!-- โ ุงูุนูุงุตุฑ ุงููุฏููุฉ -->
    <div class="section-title">๐๏ธ ุงูุนูุงุตุฑ ุงููุฏููุฉ</div>
    <table class="report-table">
      <tr>
        <th>๐งฑ ุงูุญูุงุฆุท</th><td id="walls_condition"></td>
        <th>๐ช ุงูุณูุงูู</th><td id="stairs"></td>
        <th>๐ช ุงูููุงูุฐ</th><td id="windows"></td>
      </tr>
      <tr>
        <th>๐ช ุงูุฃุจูุงุจ</th><td id="doors"></td>
        <th>๐ชต ุงูุฃุฑุถูุงุช</th><td id="floors_condition"></td>
        <th>๐ค๏ธ ุงูููุงูุฑ</th><td id="light_wells"></td>
      </tr>
      <tr>
        <th>๐ ุนุฒู ุงูุณุทุญ</th><td id="roof_insulation"></td>
        <th>๐ง ุชุตุฑูู ุงูุณุทุญ</th><td id="roof_drainage"></td>
        <th>๐งฑ ุฅุทุงุฑ ุงูุณุทุญ</th><td id="roof_frame"></td>
      </tr>
      <tr>
        <th>โฟ ููุญุฏุฑ</th><td id="accessibility_ramp"></td>
        <th>๐ณ ุงูุญุงูุฉ ุงูุฎุงุฑุฌูุฉ ูุงูุทุฑู</th><td id="external_condition"></td>
        <th>๐ช ุงูุจูุงุจุงุช</th><td id="main_gates"></td>
      </tr>
      <tr>
        <th>๐งฑ ุงูุณูุฑ</th><td id="fence"></td>
        <th>โ๏ธ ุงูุนูุงุตุฑ ุงููููุงููููุฉ</th><td id="mechanical"></td>
        <th>๐ ููุญุฉ ุงูุชูุฒูุน</th><td id="distribution"></td>
      </tr>
      <tr>
        <th>โก ุงูุชุฃุฑูุถ</th><td id="earthing"></td>
        <th>๐ ุฃูุธูุฉ ุงูุตูุช</th><td id="sound"></td>
        <th>๐ก ุงุญุงูุฉ ูุฅุถุงุกุฉ</th><td id="lighting"></td>
      </tr>
      <tr>
        <th>๐จ ุฅุถุงุกุฉ ุงูุทูุงุฑุฆ</th><td id="emergency_lighting"></td>
        <th>๐ ุงูููุงุจุณ ููููุงุช ุงูุชูุฏูุฏ</th><td id="sockets"></td>
        <th>โ๏ธ ุงูููููุงุช</th><td id="ac"></td>
      </tr>
      <tr>
        <th>๐ง ูุถุฎุงุช ุงูููุงู</th><td id="pumps"></td>
        <th>๐ฌ๏ธ ูุฑุงูุญ ุงูุดูุท</th><td id="fans"></td>
        <th>๐ ุงููุตุงุนุฏ</th><td id="elevators"></td>
      </tr>
      <tr>
        <th>๐ฅ ุณุฎุงูุงุช ุงูููุงู</th><td id="heaters"></td>
        <th>๐ฐ ุฎุฒุงู ุฃุฑุถู</th><td id="tank_ground"></td>
        <th>๐ฐ ุฎุฒุงู ุนููู</th><td id="tank_top"></td>
      </tr>
      <tr>
        <th>๐ง ุงูุญูุงุฌุฒ ูุงูุนุดูุงุฆูุงุช</th><td id="barriers"></td>
        <th>โก ุชูุตููุงุช ููุฑุจุงุฆูุฉ ุนุดูุงุฆูุฉ</th><td id="wiring"></td>
        <td colspan="2"></td>
      </tr>
    </table>
      <!-- โ ุตูุฏูู ููุฎุต ุงูุนูุงุตุฑ ุงููุฏููุฉ -->
<div class="summary-box">
  <div><strong>๐ ูุฌููุน ุงููุฏูู:</strong> <span id="civil_sum">-</span></div>
  <div><strong>ุงููุณุจุฉ:</strong> <span id="civil_percent" class="percent-box">-</span></div>
</div>

    <!-- โ ุงูุตูุฏูู ุงูููุงุฆู -->
<div class="summary-box">
  <div><strong>๐ ุงููุฌููุน ุงูููู:</strong> <span id="total_sum">-</span></div>
  <div><strong>ุงููุณุจุฉ ุงููููุฉ:</strong> <span id="total_percent" class="percent-box">-</span></div>
</div>
    <!-- โ ุญูู ุงูุงุนุชูุงุฏ -->
    <div class="section-title">๐ ุงูุงุนุชูุงุฏ</div>
    <table class="report-table">
      <tr>
        <th>ุงูุงุณููู</th>
        <td colspan="3" style="height:40px;"></td>
      </tr>
      <tr>
        <th>ุงูุชูููุน</th><td style="height:60px;"></td>
        <th>ุงูุฎุชู</th><td style="height:60px;"></td>
      </tr>
    </table>

    <button onclick="window.print()" class="print-btn">๐จ๏ธ ุทุจุงุนุฉ / ุญูุธ PDF</button>
  </div>

  <script>
    const API_URL = "/.netlify/functions/api"; 

    const urlParams = new URLSearchParams(window.location.search);
    const schoolName = urlParams.get("school");
    const visitNumber = urlParams.get("visit");

    async function loadReport() {
      const loader = document.getElementById("loader");
      const reportContainer = document.getElementById("reportContainer");

      try {
        loader.style.display = "flex";
        reportContainer.style.display = "none";

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "getVisitReport",
            school: schoolName,
            visit: visitNumber
          })
        });

        const result = await res.json();
        if (result.success) {
          const report = result.data;
          for (const key in report) {
            const el = document.getElementById(key);
            if (el) {
              let value = report[key] || "-";

              // โ ุชูุณูู ุงูุชุงุฑูุฎ (dd-mm-yyyy)
              if (key === "visit_date" && value && value !== "-") {
                const dateObj = new Date(value);
                const day = ("0" + dateObj.getDate()).slice(-2);
                const month = ("0" + (dateObj.getMonth() + 1)).slice(-2);
                const year = dateObj.getFullYear();
                value = `${day}-${month}-${year}`;
              }

              el.textContent = value;
            }
          }
                loader.style.display = "none";
      reportContainer.style.display = "block";

      // โ ููุก ุงููุฌุงููุน ูุงููุณุจ
      document.getElementById("health_sum").textContent = report.health_sum || "0";
      document.getElementById("civil_sum").textContent = report.civil_sum || "0";
      document.getElementById("total_sum").textContent = report.total_sum || "0";

      const healthPercentEl = document.getElementById("health_percent");
      healthPercentEl.textContent = (report.health_percent || 0) + "%";
      setBoxColor(healthPercentEl, report.health_percent);

      const civilPercentEl = document.getElementById("civil_percent");
      civilPercentEl.textContent = (report.civil_percent || 0) + "%";
      setBoxColor(civilPercentEl, report.civil_percent);

      const totalPercentEl = document.getElementById("total_percent");
      totalPercentEl.textContent = (report.total_percent || 0) + "%";
      setBoxColor(totalPercentEl, report.total_percent);

    } else {
      loader.style.display = "none";
      alert("โ๏ธ " + (result.message || "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุชูุฑูุฑ"));
    }
  } catch (err) {
    loader.style.display = "none";
    console.error("ุฎุทุฃ:", err);
    alert("โ ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู");
  }
}

// โ ุฏุงูุฉ ูุชูููู ุงูุตูุฏูู ุญุณุจ ุงููุณุจุฉ
function setBoxColor(element, percent) {
  if (!percent || isNaN(percent)) {
    element.style.backgroundColor = "#eee"; // ุฑูุงุฏู
    element.style.color = "#000";
    return;
  }

  if (percent >= 90) {
    element.style.backgroundColor = "#b6d7a8"; // ุฃุฎุถุฑ ูุงุชุญ
    element.style.color = "#000";
  } else if (percent >= 70) {
    element.style.backgroundColor = "#ffe599"; // ุฃุตูุฑ
    element.style.color = "#000";
  } else {
    element.style.backgroundColor = "#f4cccc"; // ุฃุญูุฑ
    element.style.color = "#000";
  }
}

loadReport();
</script>
</body>
</html>

